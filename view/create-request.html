<!-- Content Header (Page header) -->
<section class="content-header">
    <h1>创建请求</h1>
</section>

<!-- Main content -->
<section class="content">
    <div class="row">
        <div class="col-md-6">
            <div class="box box-primary">
                <div class="box-header with-border">
                    <h3 class="box-title">基本设置</h3>
                </div>
                <!-- /.box-header -->
                <div class="box-body">
                    <div class="form-group">
                        <div class="input-group">
                            <span class="input-group-addon">请求方式</span>
                            <select class="form-control" id="request-method">
                                <option value="get">GET</option>
                                <option value="post">POST</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="input-group">
                            <span class="input-group-addon">请求地址</span>
                            <input class="form-control" id="request-url" type="url" value="http://127.0.0.1/test.php" placeholder="e.g http://www.example.com/" />
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="input-group">
                            <span class="input-group-addon">记录名称</span>
                            <input class="form-control" type="text" />
                        </div>
                    </div>
                    <div class="form-group">
                        <button type="button" class="btn btn-primary" id="send-request">发送请求</button>
                        <button type="button" class="btn btn-info" id="save-request">保存记录</button>
                    </div>
                </div>
                <!-- /.box-body -->
            </div>
            <div class="box box-primary">
                <div class="box-header with-border">
                    <h3 class="box-title">Header设置</h3>
                    <div class="box-tools pull-right">
                        <button type="button" class="btn btn-box-tool add-header"><i class="fa fa-plus"></i> 新增</button>
                    </div>
                </div>
                <!-- /.box-header -->
                <div class="box-body table-responsive no-padding">
                    <table class="table table-bordered table-striped" id="header-table">
                        <tbody>
                            <tr class="table-header">
                                <th style="width: 40%">Key</th>
                                <th style="width: 40%">Value</th>
                                <th style="width: 20%">操作</th>
                            </tr>
                            <tr>
                                <td class="canEdit">Content-Type</td>
                                <td class="canEdit">text/html; charset=utf-8</td>
                                <td>
                                    <button class="btn btn-default btn-xs remove-header"><i class="fa fa-times"></i></button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <!-- /.box-body -->
            </div>
        </div>
        <div class="col-md-6">
            <div class="box box-primary">
                <div class="box-header with-border">
                    <h3 class="box-title">请求参数</h3>
                    <div class="box-tools pull-right">
                        <button type="button" class="btn btn-box-tool add-param"><i class="fa fa-plus"></i> 新增</button>
                        <button type="button" class="btn btn-box-tool from-query"><i class="fa fa-cloud-download"></i> 导入</button>
                    </div>
                </div>
                <!-- /.box-header -->
                <div class="box-body table-responsive no-padding">
                    <table class="table table-bordered table-striped" id="param-table">
                        <tbody>
                            <tr class="table-header">
                                <th style="width: 40%">Key</th>
                                <th style="width: 40%">Value</th>
                                <th style="width: 20%">操作</th>
                            </tr>
                            <tr>
                                <td class="canEdit">wd</td>
                                <td class="canEdit">aaaaa</td>
                                <td><button class="btn btn-default btn-xs remove-param"><i class="fa fa-times"></i></button></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <!-- /.box-body -->
            </div>
            <div class="box box-primary">
                <div class="box-header with-border">
                    <h3 class="box-title">文件上传</h3>
                    <div class="box-tools pull-right">
                        <button type="button" class="btn btn-box-tool add-file"><i class="fa fa-plus"></i> 新增</button>
                    </div>
                </div>
                <!-- /.box-header -->
                <div class="box-body table-responsive no-padding">
                    <table class="table table-bordered table-striped" id="file-table">
                        <tbody>
                            <tr class="table-header">
                                <th style="width: 40%">Key</th>
                                <th style="width: 40%">File</th>
                                <th style="width: 20%">操作</th>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <!-- /.box-body -->
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <div class="box box-success">
                <div class="box-header with-border">
                    <h3 class="box-title">响应</h3>
                </div>
                <div class="box-body">
                    <div class="nav-tabs-custom">
                        <ul class="nav nav-tabs">
                            <li class="active"><a href="#response-contents-tab" data-toggle="tab" aria-expanded="true">Response Contents</a></li>
                            <li class=""><a href="#response-headers-tab" data-toggle="tab" aria-expanded="false">Response Headers</a></li>
                        </ul>
                        <div class="tab-content">
                            <div class="tab-pane active" id="response-contents-tab">
                                <pre id="response-contents-show"></pre>
                            </div>
                            <div class="tab-pane" id="response-headers-tab">
                                <pre id="response-headers-show"></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="importFromQueryModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">从 Query 字符串导入参数</h4>
            </div>
            <div class="modal-body">
                <textarea id="query-string" class="form-control" rows="5" placeholder="e.g username=admin&password=admin123 or http://example.com/?u=root&p=root"></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary parse-query-string">导入参数</button>
            </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->
</section>
<!-- /.content -->
<script>

$('.add-header').click(function(){
    let row = '<tr><td class="canEdit"></td><td class="canEdit"></td><td><button class="btn btn-default btn-xs remove-header"><i class="fa fa-times"></i></button></td></tr>'
    $('#header-table').children().first().append(row)
})
$('.add-param').click(function(){
    addParamRow('', '')
})
function addParamRow(key, value){
    let row = '<tr><td class="canEdit">'+key+'</td><td class="canEdit">'+value+'</td><td><button class="btn btn-default btn-xs remove-param"><i class="fa fa-times"></i></button></td></tr>'
    $('#param-table').children().first().append(row)
}
$('.from-query').click(function(){
    $('#importFromQueryModal').modal({
        keyboard: false,
        backdrop: 'static'
    })
})
$('.parse-query-string').click(function(){
    let queryString = $('#query-string').val()
    let url = require('url')
    let obj = url.parse(queryString, true)
    if(obj.protocol === null){
        if(queryString[0] !== '?'){
            queryString = '?'+queryString
        }
        obj = url.parse(queryString, true)
    }
    let query = obj.query    
    for(let key in query){
        addParamRow(key, query[key])
    }
    $('#importFromQueryModal').modal('hide')
})
$('.add-file').click(function(){
    let row = '<tr><td class="canEdit"></td><td><input type="file"></td><td><button class="btn btn-default btn-xs remove-file"><i class="fa fa-times"></i></button></td></tr>'
    $('#file-table').children().first().append(row)
})
$('body').on('click', '.remove-header, .remove-param, .remove-file',function(){
    $(this).parent().parent().remove();
})
$('.canEdit').canEdit({input_class:'form-control'})

// 获取headers
function getHeaders(){
    let trs = $('#header-table').children('tbody').children('tr[class!="table-header"]')
    let headers = []
    let len = trs.length
    for(let i = 0; i<len; i++){
        let key = trs[i].cells[0].innerHTML
        let value = trs[i].cells[1].innerHTML
        headers[key] = value
    }
    return headers
}

// 获取参数
function getParams(){
    let trs = $('#param-table').children('tbody').children('tr[class!="table-header"]')
    let len = trs.length
    let params = []
    for(let i = 0; i<len; i++){
        let key = trs[i].cells[0].innerHTML
        let value = trs[i].cells[1].innerHTML
        params[key] = value
    }

    return params
}

// 获取需要上传的文件
function getFiles($formData){
    let trs = $('#file-table').children('tbody').children('tr[class!="table-header"]')
    let len = trs.length
    let files = []
    for(let i = 0; i<len; i++){
        let key = trs[i].cells[0].innerHTML
        let file = $(trs[i].cells[1]).children()[0].files
        console.log()
        if(file.length > 0){
            files[key] = file[0]
        }
    }
    return files
}


// 发送请求
$('#send-request').click(function(){
    let method = $('#request-method').val()
    let url = $('#request-url').val()
    
    //if(url === '') return
    
    let headers = getHeaders()
    let params = getParams()
    let files = getFiles()

    $.showLoading('正在请求...')

    let a = new DoRequest(url, method, headers, params, files)
    
    a.request(function(response){
        $('#response-contents-show').text(format(response.contentType, response.body))
        for(let n in response.headers){
            $('#response-headers-show').append(n+': '+response.headers[n]+"\r\n")
        }
        $.hideLoading()
    })
})

function format($type, $text){
    switch($type)
    {
        case 'json':
            return $.formatJSON($text)
        case 'xml':
            return $.formatXML($text)
        default:
            return $text
    }
}
</script>